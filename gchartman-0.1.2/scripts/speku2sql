#!/bin/bash

if test $# == 1; then
	
	if test -a $1; then
		awk '	BEGIN   {
					FS=";";
					printf "create table _TableNames (Name Text,TName Text,Comment Text);\n"
				}
			(NR==1)	{
					for (i=2;i<NF;i++) {
						Names[i]=$i;
						nchars=split($i,chars,"");	#gawk specific
						for (j=1;j<=nchars;j++) {
							if (match(chars[j],"[0-9A-Za-z]")) {
								TNames[i]=TNames[i] chars[j];
							} else {
								TNames[i]=TNames[i] "_";
							}
						}
						printf "insert into _TableNames (Name,TName) values(\"%s\",\"%s\");\n",Names[i],TNames[i];
						printf "create table %s (value double,volume double,minimum double,maximum double,time timestamp primary key);\n",TNames[i];
					};
				}
			(NR>1)  {	
					#Initialize Date here
					split($1,a,".");	#split date from Day.Month.Year\
					$1=a[3]"-"a[2]"-"a[1];	#reassemble as Year-Month-Day\
			        	$1=$1" 23:59:59";	#add time to date\
					#printf "<-- %s ----------------------------------------------->\n",$1;
			
					for (i=2;i<NF;i++) {
						if ($i != "") {
							gsub(/,/,".",$i); 	#Comma to dot in value
							printf "insert into %s (time,value) values(\"%s\",%s);\n",TNames[i],$1,$i;
						};
					};
				};				 
				 
				 
		    ' $1 > $1.sql
	else
		echo
		echo	File does not exist...aborted
		echo
	fi

else
	echo	'Usage: speku2sql csvfile'
	echo	'		csvfile is a csv file generated by the cvs-export module of'
	echo	'			the shareware program "Spekulator"'
	echo
	echo	'		The output is a SQL script that generates a database (complete with'
	echo	'		a "_TableNames" table) with the data from the csv file'
	echo	'		Output is: csvfile.sql'
	exit 0
fi	
